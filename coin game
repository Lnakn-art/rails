<!-- app/views/games/index.html.erb -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ゲームページ</title>
  <%= stylesheet_link_tag 'application', media: 'all' %>
</head>
<body>
  <% if @user_token == @valid_token %>
    <div id="message">ゲームをプレイしてください。</div>
    <div id="gameArea" style="display:block;">
      <canvas id="gameCanvas"></canvas>
      <div id="score">Score: 0</div>
    </div>
  <% else %>
    <div>無効なトークンです。ゲームを開始できません。</div>
  <% end %>

  <%= javascript_include_tag 'game' %>
</body>
</html>
/* app/assets/stylesheets/application.css */
body {
  font-family: Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  margin: 0;
  background-color: #f0f0f0;
  text-align: center;
}

#message {
  font-size: 20px;
  color: #ff0000;
}

#gameArea {
  display: flex;
  flex-direction: column;
  align-items: center;
}

#gameCanvas {
  background-color: #87ceeb;
  border: 2px solid #000;
}

#score {
  font-size: 18px;
  margin-top: 10px;
}

/* レスポンシブ対応 */
@media (max-width: 600px) {
  #gameCanvas {
    width: 90vw;  /* 画面幅に合わせて調整 */
    height: 60vh; /* 画面高さに合わせて調整 */
  }
}
// app/assets/javascripts/game.js

document.addEventListener("DOMContentLoaded", function() {
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  let score = 0;

  const player = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    size: 30,
    color: "red",
    speed: 5,
  };

  const treasures = [];
  const treasureSize = 40;

  function createTreasure() {
    const x = Math.random() * (canvas.width - treasureSize);
    const y = Math.random() * (canvas.height - treasureSize);
    const isWinning = Math.random() > 0.5;
    treasures.push({ x, y, isWinning });
  }

  function drawPlayer() {
    ctx.fillStyle = player.color;
    ctx.fillRect(player.x, player.y, player.size, player.size);
  }

  function drawTreasures() {
    treasures.forEach((treasure) => {
      ctx.fillStyle = treasure.isWinning ? "gold" : "gray";
      ctx.fillRect(treasure.x, treasure.y, treasureSize, treasureSize);
    });
  }

  function updateScore(value) {
    score += value;
    document.getElementById("score").textContent = `Score: ${score}`;
  }

  const keys = {};
  window.addEventListener("keydown", (e) => (keys[e.key] = true));
  window.addEventListener("keyup", (e) => (keys[e.key] = false));

  function movePlayer() {
    if (keys["ArrowUp"] && player.y > 0) player.y -= player.speed;
    if (keys["ArrowDown"] && player.y < canvas.height - player.size) player.y += player.speed;
    if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
    if (keys["ArrowRight"] && player.x < canvas.width - player.size) player.x += player.speed;

    treasures.forEach((treasure, index) => {
      if (
        player.x < treasure.x + treasureSize &&
        player.x + player.size > treasure.x &&
        player.y < treasure.y + treasureSize &&
        player.y + player.size > treasure.y
      ) {
        if (treasure.isWinning) {
          updateScore(10);
        } else {
          updateScore(-5);
        }
        treasures.splice(index, 1);
      }
    });
  }

  // タッチ操作でプレイヤーを動かす
  let touchStartX = 0;
  let touchStartY = 0;

  canvas.addEventListener("touchstart", function(event) {
    touchStartX = event.touches[0].pageX;
    touchStartY = event.touches[0].pageY;
  });

  canvas.addEventListener("touchmove", function(event) {
    const touchEndX = event.touches[0].pageX;
    const touchEndY = event.touches[0].pageY;

    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;

    player.x += deltaX / 10;  // プレイヤーの移動速度を調整
    player.y += deltaY / 10;  // プレイヤーの移動速度を調整

    touchStartX = touchEndX;
    touchStartY = touchEndY;

    event.preventDefault(); // スクロールを防止
  });

  function updateGame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawPlayer();
    drawTreasures();
    requestAnimationFrame(updateGame);
  }

  setInterval(() => {
    createTreasure();
  }, 2000);

  function gameLoop() {
    movePlayer();
    updateGame();
  }

  gameLoop();
});
